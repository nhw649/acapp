class Difficult{constructor(t){this.root=t,this.$difficult=$('\n<div class="ac-game-difficult">\n    <div class="ac-game-difficult-field">\n        <div class="difficult-field-item difficult-field-item-back">返回</div>\n        <br>\n        <br>\n        <div class="difficult-field-item difficult-field-item-easy">简单</div>\n        <br>\n        <br>\n        <div class="difficult-field-item difficult-field-item-normal">普通</div>\n        <br>\n        <br>\n        <div class="difficult-field-item difficult-field-item-hard">困难</div>\n    </div>\n    <div class="ac-game-difficult-description"></div>\n</div>\n        '),this.root.$ac_game.append(this.$difficult),this.$difficult_back=$(".difficult-field-item-back"),this.$easy=$(".difficult-field-item-easy"),this.$normal=$(".difficult-field-item-normal"),this.$hard=$(".difficult-field-item-hard"),this.$difficult_description=$(".ac-game-difficult-description"),this.start(),this.hide()}start(){this.add_listening_events()}add_listening_events(){this.$difficult_back.click((()=>{this.hide(),this.root.menu.show()})),this.$easy.mouseenter((()=>{this.$difficult_description.text("敌人数量减少，玩家移动速度更快，攻击频率变慢，火球移动距离变短，火球移动速度变慢，出生位置随机。"),this.$difficult_description.stop(!0).fadeIn(100)})),this.$easy.mouseleave((()=>{this.$difficult_description.stop(!0).fadeOut(100)})),this.$easy.click((()=>{this.difficult_mode="easy",this.hide(),this.root.skin.show()})),this.$normal.mouseenter((()=>{this.$difficult_description.text("和玩家一样，出生位置随机。"),this.$difficult_description.stop(!0).fadeIn(100)})),this.$normal.mouseleave((()=>{this.$difficult_description.stop(!0).fadeOut(100)})),this.$normal.click((()=>{this.difficult_mode="normal",this.hide(),this.root.skin.show()})),this.$hard.mouseenter((()=>{this.$difficult_description.text("敌人数量增多，速度变快，攻击频率变快，火球移动距离变长，火球移动速度变快，出生位置一样。"),this.$difficult_description.stop(!0).fadeIn(100)})),this.$hard.mouseleave((()=>{this.$difficult_description.stop(!0).fadeOut(100)})),this.$hard.click((()=>{this.difficult_mode="hard",this.hide(),this.root.skin.show()}))}show(){this.$difficult.show()}hide(){this.$difficult.hide(),this.$difficult_description.hide()}}class Melee{constructor(t){this.root=t,this.$melee=$('\n        <div class="ac-game-melee">\n            <div class="ac-game-melee-field">\n                <div class="melee-field-item melee-field-item-back">返回</div>\n                <br>\n                <br>\n                <div class="melee-field-item melee-field-item-single">单挑模式</div>\n                <br>\n                <br>\n                <div class="melee-field-item melee-field-item-three">三人乱斗</div>\n                <br>\n                <br>\n                <div class="melee-field-item melee-field-item-five">五人乱斗</div>\n            </div>\n        </div>\n        '),this.root.$ac_game.append(this.$melee),this.$melee_back=$(".melee-field-item-back"),this.$single=$(".melee-field-item-single"),this.$three=$(".melee-field-item-three"),this.$five=$(".melee-field-item-five"),this.start(),this.hide()}start(){this.add_listening_events()}add_listening_events(){this.$melee_back.click((()=>{this.hide(),this.root.menu.show()})),this.$single.click((()=>{this.root.playground.join_player_total=2,this.hide(),this.root.skin.show()})),this.$three.click((()=>{this.root.playground.join_player_total=3,this.hide(),this.root.skin.show()})),this.$five.click((()=>{this.root.playground.join_player_total=5,this.hide(),this.root.skin.show()}))}show(){this.$melee.show()}hide(){this.$melee.hide()}}class AcGameMenu{constructor(t){this.root=t,this.$menu=$('\n<div class="ac-game-menu">\n    <div class="ac-game-menu-field">\n        <div class="menu-field-item menu-field-item-single">单人模式</div>\n        <br>\n        <br>\n        <div class="menu-field-item menu-field-item-multi">多人模式</div>\n        <br>\n        <br>\n        <div class="menu-field-item menu-field-item-rank">排行榜</div>\n        <br>\n        <br>\n        <div class="menu-field-item menu-field-item-settings">设置</div>\n    </div>\n    <div class="ac-game-menu-collapse">\n        <button class="btn btn-info w-100 collapse-button font-weight-bold" data-toggle="collapse" data-target="#collapseMessage">\n            留言板\n        </button>\n        <div class="collapse" id="collapseMessage">\n            <div class="ac-game-menu-message-board">\n                <div class="message-board-content-box">\n                   <ul class="list-unstyled message-board-content"></ul>\n                </div>\n                <div class="input-group mt-3">\n                  <input type="text" class="form-control message-board-input" placeholder="请输入你想说的内容...">\n                  <div class="input-group-append">\n                    <button class="btn btn-outline-info" id="liveToastBtn">发送</button>\n                  </div>\n               </div>\n            </div>\n        </div>\n    </div>\n    <div class="toast ac-game-menu-success-toast" style="position: absolute; bottom: 5px; right: 0px;">\n        <div class="toast-header">\n          <strong class="mr-4 text-success">成功</strong>\n          <small>1s前</small>\n          <button class="ml-2 mb-1 close" data-dismiss="toast">\n            <span>&times;</span>\n          </button>\n        </div>\n        <div class="toast-body">\n          发送成功!\n        </div>\n    </div>\n    <div class="toast ac-game-menu-error-toast" style="position: absolute; bottom: 5px; right: 0px;">\n        <div class="toast-header">\n          <strong class="mr-auto text-danger">错误</strong>\n          <small>1s前</small>\n          <button class="ml-2 mb-1 close" data-dismiss="toast">\n            <span>&times;</span>\n          </button>\n        </div>\n        <div class="toast-body">\n          输入的内容不能为空!\n        </div>\n    </div>\n</div>\n'),this.root.$ac_game.append(this.$menu),this.$single=this.$menu.find(".menu-field-item-single"),this.$multi=this.$menu.find(".menu-field-item-multi"),this.$rank=this.$menu.find(".menu-field-item-rank"),this.$settings=this.$menu.find(".menu-field-item-settings"),this.$message_board=this.$menu.find(".ac-game-menu-message-board"),this.$message_board_content_box=this.$menu.find(".message-board-content-box"),this.$message_board_content=this.$menu.find(".message-board-content"),this.$message_board_input=this.$menu.find(".message-board-input"),this.$message_board_button=this.$menu.find(".ac-game-menu-message-board button"),this.$error_toast=this.$menu.find(".ac-game-menu-error-toast"),this.$success_toast=this.$menu.find(".ac-game-menu-success-toast"),this.$collapse_message=this.$menu.find("#collapseMessage"),this.hide(),this.start()}start(){this.init_audio="first",this.add_listening_events()}add_listening_events(){this.$collapse_message.on("shown.bs.collapse",(()=>{this.$message_board_content_box[0].scrollTop=this.$message_board_content_box[0].scrollHeight})),this.$single.click((()=>{this.hide(),this.$message_board.hide(),this.mode="single mode",this.root.difficult.show()})),this.$multi.click((()=>{this.hide(),this.$message_board.hide(),this.mode="multi mode",this.root.melee.show()})),this.$rank.click((()=>{this.hide(),this.$message_board.hide(),this.root.rank.show()})),this.$settings.click((()=>{this.hide(),this.$message_board.hide(),this.root.setting.show()})),this.$menu.keydown((t=>{this.$message_board_input.is(":focus")&&13===t.which&&(this.addMessage(),this.$message_board_input.val(""),this.getMessage())})),this.$message_board_button.click((()=>{this.addMessage(),this.$message_board_input.val(""),this.getMessage()}))}addMessage(){let t=this.$message_board_input.val();if(!t)return this.$error_toast.toast({delay:2e3}),this.$error_toast.toast("show"),!1;$.ajax({url:"/menu/addMessage/",type:"POST",async:!1,data:{username:this.root.settings.username,photo:this.root.settings.photo,text:t,csrfmiddlewaretoken:$('input[name="csrfmiddlewaretoken"]').val()},success:t=>{t.result,this.$success_toast.toast({delay:2e3}),this.$success_toast.toast("show")}})}getMessage(){$.ajax({url:"/menu/getMessage/",type:"GET",async:!1,success:t=>{this.$message_board_content.html("");let i=t.data;for(let t=0;t<i.length;t++){let s=$(`\n                    <hr>\n                    <li class="media mt-2 pl-3 pr-3">\n                        <img src="${i[t].photo}" width="40" class="rounded mr-3">\n                        <div class="media-body">\n                          <h5 class="mt-0 mb-0">${i[t].username}</h5>\n                          <p class="create-time mb-2 text-secondary">${i[t].create_time}</p>\n                          <p class="mb-0">${i[t].text}</p>\n                        </div>\n                    </li>\n                    `);this.$message_board_content.append(s)}this.$message_board_content_box[0].scrollTop=this.$message_board_content_box[0].scrollHeight}})}show(){this.$menu.show(),this.getMessage(),this.$message_board.show(),this.$collapse_message.collapse("show"),"first"===this.init_audio&&($("audio")[0].play(),this.init_audio=null)}hide(){this.$menu.hide()}}let last_timestamp,AC_GAME_OBJECTS=[];class AcGameObject{constructor(){AC_GAME_OBJECTS.push(this),this.has_called_start=!1,this.timedelta=0,this.uuid=this.create_uuid()}create_uuid(){let t="";for(let i=0;i<8;i++)t+=Math.floor(10*Math.random());return t}start(){}update(){}late_update(){}on_destroy(){}destroy(){this.on_destroy();for(let t=0;t<AC_GAME_OBJECTS.length;t++)if(AC_GAME_OBJECTS[t]===this){AC_GAME_OBJECTS.splice(t,1);break}}}let AC_GAME_ANIMATION=t=>{for(let i=0;i<AC_GAME_OBJECTS.length;i++){let s=AC_GAME_OBJECTS[i];s.has_called_start?(s.timedelta=t-last_timestamp,s.update()):(s.start(),s.has_called_start=!0)}for(let t=0;t<AC_GAME_OBJECTS.length;t++){AC_GAME_OBJECTS[t].late_update()}last_timestamp=t,requestAnimationFrame(AC_GAME_ANIMATION)};requestAnimationFrame(AC_GAME_ANIMATION);class ChatField{constructor(t){this.playground=t,this.$history=$("<div class='chat-field-history'></div>"),this.$input=$("<input type='text' class='chat-field-input' placeholder='请输入聊天内容...'>"),this.$history.hide(),this.$input.hide(),this.playground.$playground.append(this.$history),this.playground.$playground.append(this.$input),this.timer_id=null,this.start()}start(){this.add_listening_events()}add_listening_events(){this.$history.on("contextmenu",(function(){return!1})),this.$input.keydown((t=>{if(27===t.which&&this.$input.is(":focus"))return this.hide_input(),!1;if(13===t.which&&this.$input.val()&&this.$input.is(":focus")){let t=this.playground.root.settings.username,i=this.$input.val();return i&&(this.add_message(t,i),this.$input.val(""),this.playground.mps.send_chat_message(t,i)),!1}return 13===t.which&&""===this.$input.val()&&this.$input.is(":focus")?(this.hide_input(),!1):void 0})),this.$input.blur((()=>{this.hide_history(),this.$input.hide()}))}render_message(t){return $(`<div>${t}</div>`)}dateFormat(t,i){let s;const e={"Y+":i.getFullYear().toString(),"m+":(i.getMonth()+1).toString(),"d+":i.getDate().toString(),"H+":i.getHours().toString(),"M+":i.getMinutes().toString(),"S+":i.getSeconds().toString()};for(let i in e)s=new RegExp("("+i+")").exec(t),s&&(t=t.replace(s[1],1==s[1].length?e[i]:e[i].padStart(s[1].length,"0")));return t}add_message(t,i){this.show_history();let s=new Date,e=`<text style="color: green;">[${this.dateFormat("HH:MM:SS",s)}]</text> <text style="color: #1565c0;">${t}: </text>${i}`;this.$history.append(this.render_message(e)),this.$history.scrollTop(this.$history[0].scrollHeight),"none"===this.$input.css("display")&&this.hide_history()}show_history(){this.timer_id&&clearTimeout(this.timer_id),this.$history.fadeIn()}hide_history(){this.timer_id&&clearTimeout(this.timer_id),this.timer_id=setTimeout((()=>{this.$history.fadeOut(),this.timer_id=null}),3e3)}show_input(){this.$input.show(),this.$input.focus(),this.show_history()}hide_input(){this.$input.val(""),this.hide_history(),this.$input.hide(),this.playground.game_map.$canvas.focus()}}class CountDown extends AcGameObject{constructor(t){super(),this.playground=t,this.ctx=this.playground.game_map.ctx,this.text="5"}start(){}write(t){t>0&&(this.text=t)}late_update(){this.render()}render(){if("multi mode"===this.playground.mode&&this.playground.players.length!==this.playground.join_player_total)return!1;this.ctx.fillStyle="rgba(0,0,0,0.2)",this.ctx.fillRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.ctx.font="45px 黑体",this.ctx.fillStyle="rgb(113,248,83)",this.ctx.textAlign="center",this.ctx.textBaseline="top",this.ctx.fillText("快去找个好位置,距离游戏开始还剩:"+this.text+"s",this.playground.width/2,this.playground.height/4)}}class Grid extends AcGameObject{constructor(t,i,s,e,a,h){super(),this.playground=t,this.ctx=i,this.i=s,this.j=e,this.l=a,this.x=this.i*this.l,this.y=this.j*this.l,this.stroke_color=h}start(){}update(){this.render()}render(){let t=this.playground.scale,i=this.x-this.playground.cx,s=this.y-this.playground.cy,e=i+.5*this.l,a=s+.5*this.l;e*t<-.2*this.playground.width||e*t>1.2*this.playground.width||a*t<-.2*this.playground.height||a*t>1.2*this.playground.height||this.render_grid(i,s,t)}render_grid(t,i,s){this.ctx.save(),this.ctx.beginPath(),this.ctx.lineWidth=.005*this.l*s,this.ctx.strokeStyle=this.stroke_color,this.ctx.rect(t*s,i*s,this.l*s,this.l*s),this.ctx.stroke(),this.ctx.restore()}}class GameMap extends AcGameObject{constructor(t){super(),this.playground=t,this.$canvas=$('<canvas tabindex=0 class="game-map">你的浏览器居然不支持Canvas?赶快换一个吧!!</canvas>'),this.ctx=this.$canvas[0].getContext("2d"),this.ctx.canvas.width=this.playground.width,this.ctx.canvas.height=this.playground.height,this.playground.$playground.append(this.$canvas);let i=this.playground.virtual_map_width,s=this.playground.virtual_map_height;this.l=.05*s,this.nx=Math.ceil(i/this.l),this.ny=Math.ceil(s/this.l),this.generate_grids()}start(){this.$canvas.focus(),this.add_listening_events()}generate_grids(){this.grids=[];for(let t=0;t<this.ny;t++)for(let i=0;i<this.nx;i++)this.grids.push(new Grid(this.playground,this.ctx,i,t,this.l,"rgba(222, 237, 225)"))}add_listening_events(){this.$canvas.click((()=>{this.$canvas.focus()}))}update(){this.render()}resize(){this.ctx.canvas.width=this.playground.width,this.ctx.canvas.height=this.playground.height,this.ctx.fillStyle="rgb(137,190,178)",this.ctx.fillRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height)}render(){this.ctx.fillStyle="rgb(137,190,178)",this.ctx.fillRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height)}on_destroy(){for(let t=0;t<this.grids.length;t++)this.grids[t].destroy();this.grids=[]}}class MiniMap extends AcGameObject{constructor(t){super(),this.playground=t,this.$canvas=$('<canvas class="mini-map"></canvas>'),this.ctx=this.$canvas[0].getContext("2d"),this.bg_color="rgba(0, 0, 0, 0.3)",this.bright_color="rgba(247, 232, 200, 0.7)",this.players=this.playground.players,this.pos_x=this.playground.width-.3*this.playground.height,this.pos_y=.7*this.playground.height,this.width=.3*this.playground.height,this.height=this.width,this.ctx.canvas.width=this.width,this.ctx.canvas.height=this.height,this.playground.$playground.append(this.$canvas),this.real_map_width=this.playground.virtual_map_width,this.lock=!1,this.drag=!1}start(){this.add_listening_events()}resize(){this.pos_x=this.playground.width-.3*this.playground.height,this.pos_y=.7*this.playground.height,this.width=.3*this.playground.height,this.height=this.width,this.ctx.canvas.width=this.width,this.ctx.canvas.height=this.height,this.margin_right=(this.playground.$playground.width()-this.playground.width)/2,this.margin_bottom=(this.playground.$playground.height()-this.playground.height)/2,this.$canvas.css({position:"absolute",right:this.margin_right,bottom:this.margin_bottom})}add_listening_events(){let t=this;this.$canvas.on("contextmenu",(function(){return!1})),this.$canvas.mousedown((function(i){if("waiting"===t.playground.state)return!0;const s=t.ctx.canvas.getBoundingClientRect();let e=i.clientX-s.left,a=i.clientY-s.top,h=e/t.width*t.playground.virtual_map_width,l=a/t.height*t.playground.virtual_map_height;if(1===i.which)t.lock=!0,t.drag=!1,t.playground.focus_player=null,t.playground.re_calculate_cx_cy(h,l),t.rect_x1=e-t.playground.width/2/t.playground.scale/t.playground.virtual_map_width*t.width,t.rect_y1=a-t.playground.height/2/t.playground.scale/t.playground.virtual_map_height*t.height;else if(3===i.which){let i=t.playground.players[0];"me"===i.character&&(i.move_to(h,l),"multi mode"===t.playground.mode&&t.playground.mps.send_move_to(h,l))}})),this.$canvas.mousemove((function(i){const s=t.ctx.canvas.getBoundingClientRect();let e=i.clientX-s.left,a=i.clientY-s.top,h=e/t.width*t.playground.virtual_map_width,l=a/t.height*t.playground.virtual_map_height;1===i.which&&t.lock&&(t.drag=!0,t.playground.focus_player=null,t.playground.re_calculate_cx_cy(h,l),t.rect_x1=e-t.playground.width/2/t.playground.scale/t.playground.virtual_map_width*t.width,t.rect_y1=a-t.playground.height/2/t.playground.scale/t.playground.virtual_map_height*t.height)})),this.$canvas.mouseup((function(i){t.lock&&(t.lock=!1),t.playground.game_map.$canvas.focus()}))}update(){this.render()}render(){let t=this.playground.scale;this.ctx.clearRect(0,0,this.width,this.height),this.ctx.fillStyle=this.bg_color,this.ctx.fillRect(0,0,this.width,this.height),this.playground.focus_player&&(this.rect_x1=(this.playground.focus_player.x-this.playground.width/2/t)/this.real_map_width*this.width,this.rect_y1=(this.playground.focus_player.y-this.playground.height/2/t)/this.real_map_width*this.height);let i=this.playground.width/t/this.real_map_width*this.width,s=this.playground.height/t/this.real_map_width*this.height;this.ctx.save(),this.ctx.strokeStyle=this.bright_color,this.ctx.setLineDash([15,5]),this.ctx.lineWidth=Math.ceil(3*t/1080),this.ctx.strokeRect(this.rect_x1,this.rect_y1,i,s),this.ctx.restore();for(let t=0;t<this.players.length;t++){let i=this.players[t],s=i.x/this.real_map_width*this.width,e=i.y/this.real_map_width*this.height;this.ctx.beginPath(),this.ctx.arc(s,e,.05*this.width,0,2*Math.PI,!1),"me"===i.character?this.ctx.fillStyle="green":this.ctx.fillStyle="red",this.ctx.fill()}}}class NoticeBoard extends AcGameObject{constructor(t){super(),this.playground=t,this.ctx=this.playground.game_map.ctx,this.text="匹配中..."}start(){}write(t){this.text=t}update(){this.render()}render(){this.ctx.font="20px 黑体",this.ctx.fillStyle="white",this.ctx.textAlign="center",this.ctx.textBaseline="top",this.ctx.fillText(this.text,this.playground.width/2,5)}}class ClickParticle extends AcGameObject{constructor(t,i,s,e){super(),this.playground=t,this.ctx=this.playground.game_map.ctx,this.x=i,this.y=s,this.color=e,this.angle=Math.random()*Math.PI*2,this.vx=Math.cos(this.angle),this.vy=Math.sin(this.angle),this.radius=.01,this.eps=.001}start(){}update(){if(this.radius<this.eps)return this.destroy(),!1;this.x+=1.2*this.vx/this.playground.scale,this.y+=1.2*this.vy/this.playground.scale,this.radius*=.8,this.render()}render(){let t=this.playground.scale,i=this.x-this.playground.cx,s=this.y-this.playground.cy;i<-.1*this.playground.width/t||i>1.1*this.playground.width/t||s<-.1*this.playground.height/t||s>1.1*this.playground.height/t||(this.ctx.beginPath(),this.ctx.arc(i*t,s*t,this.radius*t,0,2*Math.PI,!1),this.ctx.fillStyle=this.color,this.ctx.fill())}}class Particle extends AcGameObject{constructor(t,i,s,e,a,h,l,n,r){super(),this.playground=t,this.ctx=this.playground.game_map.ctx,this.x=i,this.y=s,this.radius=e,this.vx=h,this.vy=l,this.color=a,this.speed=n,this.move_length=r,this.friction=.9,this.eps=.01}start(){}update(){if(.1*this.speed<this.eps)return this.destroy(),!1;let t=Math.min(this.move_length,this.speed*this.timedelta/1e3);this.x+=this.vx*t,this.y+=this.vy*t,this.move_length-=t,this.speed*=this.friction,this.render()}render(){let t=this.playground.scale,i=this.x-this.playground.cx,s=this.y-this.playground.cy;i<-.1*this.playground.width/t||i>1.1*this.playground.width/t||s<-.1*this.playground.height/t||s>1.1*this.playground.height/t||(this.ctx.beginPath(),this.ctx.arc(i*t,s*t,this.radius*t,0,2*Math.PI,!1),this.ctx.fillStyle=this.color,this.ctx.fill())}}class Player extends AcGameObject{constructor(t,i,s,e,a,h,l,n,r){super(),this.playground=t,this.ctx=this.playground.game_map.ctx,this.x=i,this.y=s,this.vx=0,this.vy=0,this.damage_x=0,this.damage_y=0,this.damage_speed=0,this.friction=.9,this.radius=e,this.color=a,this.speed=h,this.character=l,this.username=n,this.photo=r,this.move_length=0,this.eps=.01,this.spend_time=5,this.skills=[],this.cur_skill=null,this.is_attack_iceball=!1,this.ball_speed=.7,this.ball_move_length=1.4,this.max_hp=100,this.hp=100,this.img=new Image,this.img.src=this.photo||"https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fae01.alicdn.com%2Fkf%2FH544f69316f7941e0aa8e16ddb0957367F.jpg&refer=http%3A%2F%2Fae01.alicdn.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=jpeg?sec=1643330881&t=6141465282424729b082d7b3f5e29b89","me"===this.character&&(this.fireball_coldtime=1,this.iceball_coldtime=2,this.blink_coldtime=3,this.fireball_img=new Image,this.fireball_img.src="https://django-project.oss-cn-shanghai.aliyuncs.com/playground/skill/fireball.png",this.iceball_img=new Image,this.iceball_img.src="https://game.gtimg.cn/images/lol/act/img/spell/NunuW.png",this.blink_img=new Image,this.blink_img.src="https://django-project.oss-cn-shanghai.aliyuncs.com/playground/skill/blink.png")}start(){this.adjust_skill(),this.playground.player_count++,("single mode"===this.playground.mode||"multi mode"===this.playground.mode&&this.playground.player_count>=this.playground.join_player_total)&&(this.playground.state="fighting"),"me"===this.character?this.add_listening_events():"robot"===this.character&&(this.random_position_timerId=setInterval((()=>{this.update_robot_move()}),5e3))}adjust_skill(){"single mode"===this.playground.mode&&(this.difficult_mode=this.playground.root.difficult.difficult_mode,"me"===this.character?"easy"===this.difficult_mode?(this.ball_speed=.7,this.ball_move_length=1.3):"normal"===this.difficult_mode?(this.ball_speed=.7,this.ball_move_length=1.4):"hard"===this.difficult_mode&&(this.ball_speed=.8,this.ball_move_length=1.4):"robot"===this.character&&("easy"===this.difficult_mode?(this.ball_speed=.6,this.ball_move_length=1.3,this.attack_frequency=1/800):"normal"===this.difficult_mode?(this.ball_speed=.7,this.ball_move_length=1.4,this.attack_frequency=1/400):"hard"===this.difficult_mode&&(this.ball_speed=.8,this.ball_move_length=1.5,this.attack_frequency=.005)))}add_listening_events(){this.playground.game_map.$canvas.mousedown((t=>{if("fighting"!==this.playground.state)return!1;const i=this.ctx.canvas.getBoundingClientRect();let s=(t.clientX-i.left)/this.playground.scale+this.playground.cx,e=(t.clientY-i.top)/this.playground.scale+this.playground.cy;if(3===t.which){if(s<0||s>this.playground.virtual_map_width||e<0||e>this.playground.virtual_map_height)return;for(let t=0;t<20;t++)new ClickParticle(this.playground,s,e,"rgb(74,149,58)");if(this.move_to(s,e),"multi mode"===this.playground.mode&&this.playground.mps.send_move_to(s,e),"blink"===this.cur_skill){if(this.blink_coldtime>0)return!1;this.blink(s,e),"multi mode"===this.playground.mode&&this.playground.mps.send_blink(s,e)}}else if(1===t.which)if("fireball"===this.cur_skill){if(this.fireball_coldtime>0)return!1;let t=this.shoot_ball(s,e,this.cur_skill);"multi mode"===this.playground.mode&&this.playground.mps.send_shoot_ball(s,e,t.uuid,this.cur_skill)}else if("iceball"===this.cur_skill){if(this.iceball_coldtime>0)return!1;let t=this.shoot_ball(s,e,this.cur_skill);"multi mode"===this.playground.mode&&this.playground.mps.send_shoot_ball(s,e,t.uuid,this.cur_skill)}this.cur_skill=null})),this.playground.game_map.$canvas.keydown((t=>{if(32===t.which)return this.playground.re_calculate_cx_cy(),!1;if("fighting"!==this.playground.state)return!0;if(81===t.which)return this.fireball_coldtime>0||(this.cur_skill="fireball",!1);if(87===t.which)console.log("护盾技能");else{if(69===t.which)return this.iceball_coldtime>0||(this.cur_skill="iceball",!1);if(70===t.which)return this.blink_coldtime>0||(this.cur_skill="blink",!1)}}))}shoot_ball(t,i,s){let e=this.x,a=this.y,h=Math.atan2(i-this.y,t-this.x),l=Math.cos(h),n=Math.sin(h);if("fireball"===s){let t="orange",i=new Ball(this.playground,this,e,a,.01,l,n,t,this.ball_speed,this.ball_move_length,.0025,s);return this.skills.push(i),this.fireball_coldtime=1,i}if("iceball"===s){let t="#4b8fe5",i=new Ball(this.playground,this,e,a,.01,l,n,t,this.ball_speed,this.ball_move_length,.0025,s);return this.skills.push(i),this.iceball_coldtime=2,i}}destroy_ball(t){for(let i=0;i<this.skills.length;i++){let s=this.skills[i];if(s.uuid===t){s.destroy();break}}}blink(t,i){let s=this.get_dist(this.x,this.y,t,i);s=Math.min(s,.4);let e=Math.atan2(i-this.y,t-this.x);this.x+=s*Math.cos(e),this.y+=s*Math.sin(e),"robot"!==this.character&&(this.blink_coldtime=3,this.move_length-=s)}move_to(t,i){this.move_length=this.get_dist(this.x,this.y,t,i);let s=Math.atan2(i-this.y,t-this.x);this.vx=Math.cos(s),this.vy=Math.sin(s)}receive_attack(t,i,s,e,a,h,l){h.destroy_ball(a),this.x=t,this.y=i,this.is_attacked(s,e,l)}is_attacked(t,i,s){if("fireball"===s){for(let t=0;t<10*Math.random()+10;t++){let t=this.x,i=this.y,s=this.radius*Math.random()*.5,e=this.color,a=2*Math.PI*Math.random(),h=Math.cos(a),l=Math.sin(a),n=6*this.speed,r=this.radius*Math.random()*3.5;new Particle(this.playground,t,i,s,e,h,l,n,r)}if(this.radius-=.5*i,this.hp-=10,this.hp<=0)return this.destroy(),!1;this.damage_x=Math.cos(t),this.damage_y=Math.sin(t),this.damage_speed=350*i,this.speed*=.98}else if("iceball"===s){if(this.is_attack_iceball=!0,this.radius-=.25*i,this.hp-=5,this.hp<=0)return this.destroy(),!1;this.damage_x=Math.cos(t),this.damage_y=Math.sin(t),this.damage_speed=350*i,this.speed*=.45,setTimeout((()=>{this.is_attack_iceball=!1,this.speed/=.45}),2500)}}get_dist(t,i,s,e){let a=s-t,h=e-i;return Math.sqrt(a*a+h*h)}update(){("single mode"===this.playground.mode||"multi mode"===this.playground.mode&&this.playground.players.length===this.playground.join_player_total)&&this.update_count_down(),this.update_move(),this.update_board(),("me"===this.character&&this.playground.focus_player===this||"over"===this.playground.state&&this.playground.focus_player)&&this.playground.re_calculate_cx_cy(),this.render(),this.spend_time<=0&&(this.update_robot_skill(),this.update_coldtime(),this.update_win())}update_count_down(){this.spend_time>0?this.playground.count_down.write(Math.ceil(this.spend_time)):this.playground.count_down.destroy(),this.spend_time-=this.timedelta/1e3}update_win(){"fighting"===this.playground.state&&"me"===this.character&&1===this.playground.players.length&&(this.playground.state="over",this.playground.score_board.win()),"over"===this.playground.state&&"me"===this.character&&1===this.playground.players.length&&this.playground.notice_board.write("胜利!")}update_board(){if("fighting"===this.playground.state)"single mode"===this.playground.mode?this.playground.notice_board.write("战斗中!  玩家数量:"+this.playground.players.length+"/"+(this.playground.robot_total+1)):"multi mode"===this.playground.mode&&this.playground.notice_board.write("战斗中!  玩家数量:"+this.playground.players.length+"/"+this.playground.join_player_total);else if("over"===this.playground.state){let t=this.playground.players.length;this.playground.focus_index=(this.playground.focus_index%t+t)%t,"single mode"===this.playground.mode?this.playground.notice_board.write("观战中...  玩家数量:"+this.playground.players.length+"/"+(this.playground.robot_total+1)):"multi mode"===this.playground.mode&&this.playground.notice_board.write("观战中...  玩家数量:"+this.playground.players.length+"/"+this.playground.join_player_total)}}update_coldtime(){"me"===this.character&&"fighting"===this.playground.state&&(this.fireball_coldtime-=this.timedelta/1e3,this.fireball_coldtime=Math.max(this.fireball_coldtime,0),this.iceball_coldtime-=this.timedelta/1e3,this.iceball_coldtime=Math.max(this.iceball_coldtime,0),this.blink_coldtime-=this.timedelta/1e3,this.blink_coldtime=Math.max(this.blink_coldtime,0))}update_robot_move(){let t=Math.random()*this.playground.virtual_map_width,i=Math.random()*this.playground.virtual_map_height;this.move_to(t,i),this.spend_time<=0&&Math.random()<.15&&this.blink(t,i)}update_robot_skill(){if("robot"===this.character&&this.spend_time<=0&&Math.random()<this.attack_frequency){let t=this.playground.players[Math.floor(Math.random()*this.playground.players.length)];for(;t===this;)if(t=this.playground.players[Math.floor(Math.random()*this.playground.players.length)],1===this.playground.players.length)return!1;let i=t.x+this.vx*this.speed*this.timedelta/1e3*.3,s=t.y+this.vy*this.speed*this.timedelta/1e3*.3;this.shoot_ball(i,s,"fireball")}}update_move(){if(this.damage_speed>this.eps)this.vx=this.vy=0,this.move_length=0,this.cur_skill=null,this.x+=this.damage_x*this.damage_speed*this.timedelta/1e3,this.y+=this.damage_y*this.damage_speed*this.timedelta/1e3,this.damage_speed*=this.friction;else if(this.move_length<this.eps)this.move_length=0,this.vx=this.vy=0,"robot"===this.character&&this.update_robot_move();else{let t=Math.min(this.move_length,this.speed*this.timedelta/1e3);this.x+=t*this.vx,this.y+=t*this.vy,this.move_length-=t}}on_destroy(){for(let t=0;t<this.playground.players.length;t++){let i=this.playground.players[t];if(i===this){"robot"===i.character&&clearInterval(i.random_position_timerId),this.playground.players.splice(t,1),this.playground.player_count--;break}}"me"===this.character&&"fighting"===this.playground.state&&(this.playground.state="over",this.playground.score_board.lose())}render_skill_photo(t,i,s,e,a,h){this.ctx.save(),this.ctx.beginPath(),this.ctx.arc(i*t,s*t,e*t,0,2*Math.PI,!1),this.ctx.stroke(),this.ctx.clip(),this.ctx.drawImage(a,(i-e)*t,(s-e)*t,2*e*t,2*e*t),this.ctx.font="bold 25px Arial",this.ctx.fillStyle="white",this.ctx.textBaseline="middle",this.ctx.fillText(h,i*t,s*t*1.02),this.ctx.restore(),this.ctx.text}render_skill_mask(t,i,s,e,a,h){a>0&&(a===h&&(a=0),this.ctx.beginPath(),this.ctx.lineTo(i*t,s*t),this.ctx.arc(i*t,s*t,e*t,0-Math.PI/2,(1-a/h)*Math.PI*2-Math.PI/2,!0),this.ctx.lineTo(i*t,s*t),this.ctx.fillStyle="rgba(0,0,0,0.5)",this.ctx.fill())}render_skill_coldtime(){let t=this.playground.scale,i=1.13,s=.9,e=.04;this.render_skill_photo(t,i,s,e,this.fireball_img,"Q"),this.render_skill_mask(t,i,s,e,this.fireball_coldtime,1),i=1.25,this.render_skill_photo(t,i,s,e,this.iceball_img,"E"),this.render_skill_mask(t,i,s,e,this.iceball_coldtime,2),i=1.37,this.render_skill_photo(t,i,s,e,this.blink_img,"F"),this.render_skill_mask(t,i,s,e,this.blink_coldtime,3)}render_hp(t,i,s,e,a){let h=1.5*this.radius*e,l=1.2*this.radius*e,n=1.2*this.radius*e;this.ctx.strokeStyle="white",this.ctx.beginPath(),this.ctx.moveTo(t-n,i-h),this.ctx.lineTo(t+n,i-h),this.ctx.lineTo(t+n,i-l),this.ctx.lineTo(t-n,i-l),this.ctx.lineTo(t-n,i-h),this.ctx.stroke();let r=this.hp/this.max_hp;this.ctx.beginPath(),this.ctx.rect(t-n,i-h,2*n*r,.3*this.radius*e),this.ctx.fillStyle=a,this.ctx.fill(),this.ctx.closePath(),this.ctx.beginPath(),this.ctx.rect(t+n,i-h,-(t+n)*r,.3*this.radius*e),this.ctx.fillStyle="rgba(0,0,0,0)",this.ctx.fill(),this.ctx.closePath(),this.ctx.font=.015*e+"px bold 微软雅黑",this.ctx.fillStyle="white",this.ctx.textBaseline="top",this.ctx.fillText(this.hp+"/100",t,i-h)}render(){let t=this.playground.scale,i=this.x-this.playground.cx,s=this.y-this.playground.cy;(i<-.2*this.playground.width/t||i>1.2*this.playground.width/t||s<-.2*this.playground.height/t||s>1.2*this.playground.height/t)&&"me"!=this.character||("me"===this.character?this.render_hp(i*t,s*t,this.radius*t,t,"rgb(51, 226, 40)"):this.render_hp(i*t,s*t,this.radius*t,t,"rgb(249, 19, 51)"),this.ctx.save(),this.ctx.beginPath(),this.ctx.arc(i*t,s*t,this.radius*t,0,2*Math.PI,!1),this.ctx.stroke(),this.ctx.clip(),this.ctx.drawImage(this.img,(i-this.radius)*t,(s-this.radius)*t,2*this.radius*t,2*this.radius*t),this.is_attack_iceball&&(this.ctx.fillStyle="rgba(72, 149, 239, 0.4)",this.ctx.fill()),this.ctx.restore(),"robot"!==this.character&&(this.ctx.beginPath(),this.ctx.font=.02*t+"px bold 微软雅黑",this.ctx.fillStyle="white",this.ctx.textBaseline="alphabetic",this.ctx.fillText(this.username,i*t,s*t-1.8*this.radius*t)),"me"===this.character&&"fighting"===this.playground.state&&this.render_skill_coldtime())}}class ScoreBoard extends AcGameObject{constructor(t){super(),this.playground=t,this.ctx=this.playground.game_map.ctx,this.state=null,this.win_img=new Image,this.win_img.src="https://django-project.oss-cn-shanghai.aliyuncs.com/playground/score-board/win.png",this.lose_img=new Image,this.lose_img.src="https://django-project.oss-cn-shanghai.aliyuncs.com/playground/score-board/lose.png",this.close_draw_img=!1}start(){}late_update(){this.render()}add_listening_events(){this.$canvas=this.playground.game_map.$canvas,"single mode"===this.playground.mode?this.$canvas.keydown((t=>{27===t.which&&(this.playground.hide(),this.playground.root.menu.show())})):"multi mode"===this.playground.mode&&this.$canvas.keydown((t=>{27!==t.which||this.playground.chat_field.$input.is(":focus")||(this.playground.hide(),this.playground.root.menu.show())})),this.timerId=setTimeout((()=>{this.close_draw_img=!0}),2e3)}win(){this.state="win",this.add_listening_events()}lose(){this.state="lose",this.add_listening_events()}render_back(t){this.ctx.font="24px 微软雅黑",this.ctx.fillStyle="white",this.ctx.textAlign="center",this.ctx.fillText("Q/E:切换观战角色",this.playground.width/2,.9*t),this.ctx.fillText("ESC:返回菜单",this.playground.width/2,.95*t)}render(){let t=this.playground.scale,i=this.playground.height/2;"win"===this.state?(this.ctx.drawImage(this.win_img,this.playground.width/2-i/2,this.playground.height/2-i/2,i,i),this.render_back(t)):"lose"===this.state&&(this.close_draw_img||this.ctx.drawImage(this.lose_img,this.playground.width/2-i/2,this.playground.height/2-i/2,i,i),this.render_back(t))}}class Ball extends AcGameObject{constructor(t,i,s,e,a,h,l,n,r,o,d,c){super(),this.playground=t,this.player=i,this.ctx=this.playground.game_map.ctx,this.x=s,this.y=e,this.radius=a,this.vx=h,this.vy=l,this.color=n,this.speed=r,this.move_length=o,this.damage=d,this.eps=.1,this.cur_skill=c}start(){}update(){if(this.move_length<this.eps)return this.destroy(),!1;this.update_move(),"enemy"!==this.player.character&&this.update_attack(),this.render()}update_move(){let t=Math.min(this.move_length,this.speed*this.timedelta/1e3);this.x+=this.vx*t,this.y+=this.vy*t,this.move_length-=t}update_attack(){for(let t=0;t<this.playground.players.length;t++){let i=this.playground.players[t];if(i!==this.player&&this.is_collision(i)){this.attacked(i);break}}}get_dist(t,i,s,e){let a=t-s,h=i-e;return Math.sqrt(a*a+h*h)}is_collision(t){return this.get_dist(this.x,this.y,t.x,t.y)<t.radius+this.radius}attacked(t){let i=Math.atan2(t.y-this.y,t.x-this.x);t.is_attacked(i,this.damage,this.cur_skill),"multi mode"===this.playground.mode&&this.playground.mps.send_attack(t.uuid,t.x,t.y,i,this.damage,this.uuid,this.cur_skill),this.destroy()}render(){let t=this.playground.scale,i=this.x-this.playground.cx,s=this.y-this.playground.cy;i<-.1*this.playground.width/t||i>1.1*this.playground.width/t||s<-.1*this.playground.height/t||s>1.1*this.playground.height/t||(this.ctx.beginPath(),this.ctx.arc(i*t,s*t,this.radius*t,0,2*Math.PI,!1),this.ctx.fillStyle=this.color,this.ctx.fill())}on_destroy(){let t=this.player.skills;for(let i=0;i<t.length;i++)if(t[i]===this){t.splice(i,1);break}}}class FireBall extends AcGameObject{constructor(t,i,s,e,a,h,l,n,r,o,d){super(),this.playground=t,this.player=i,this.ctx=this.playground.game_map.ctx,this.x=s,this.y=e,this.radius=a,this.vx=h,this.vy=l,this.color=n,this.speed=r,this.move_length=o,this.damage=d,this.eps=.1}start(){}update(){if(this.move_length<this.eps)return this.destroy(),!1;this.update_move(),"enemy"!==this.player.character&&this.update_attack(),this.render()}update_move(){let t=Math.min(this.move_length,this.speed*this.timedelta/1e3);this.x+=this.vx*t,this.y+=this.vy*t,this.move_length-=t}update_attack(){for(let t=0;t<this.playground.players.length;t++){let i=this.playground.players[t];if(i!==this.player&&this.is_collision(i)){this.attacked(i);break}}}get_dist(t,i,s,e){let a=t-s,h=i-e;return Math.sqrt(a*a+h*h)}is_collision(t){return this.get_dist(this.x,this.y,t.x,t.y)<t.radius+this.radius}attacked(t){let i=Math.atan2(t.y-this.y,t.x-this.x);t.is_attacked(i,this.damage,"fireball"),"multi mode"===this.playground.mode&&this.playground.mps.send_attack(t.uuid,t.x,t.y,i,this.damage,this.uuid,"fireball"),this.destroy()}render(){let t=this.playground.scale,i=this.x-this.playground.cx,s=this.y-this.playground.cy;i<-.1*this.playground.width/t||i>1.1*this.playground.width/t||s<-.1*this.playground.height/t||s>1.1*this.playground.height/t||(this.ctx.beginPath(),this.ctx.arc(i*t,s*t,this.radius*t,0,2*Math.PI,!1),this.ctx.fillStyle=this.color,this.ctx.fill())}on_destroy(){let t=this.player.skills;for(let i=0;i<t.length;i++)if(t[i]===this){t.splice(i,1);break}}}class MultiPlayerSocket{constructor(t){this.playground=t,this.ws=new WebSocket("wss://app372.acapp.acwing.com.cn/wss/multiplayer/"),this.start()}start(){this.receive()}get_player(t){let i=this.playground.players;for(let s=0;s<i.length;s++){let e=i[s];if(e.uuid===t)return e}return null}receive(){this.ws.onmessage=t=>{let i=JSON.parse(t.data),s=i.event,e=i.uuid;if(e===this.uuid)return!1;"create_player"===s?this.receive_create_player(e,i.username,i.photo,i.px,i.py):"move_to"===s?this.receive_move_to(e,i.tx,i.ty):"shoot_ball"===s?this.receive_shoot_ball(e,i.tx,i.ty,i.ball_uuid,i.cur_skill):"attack"===s?this.receive_attack(e,i.attackee_uuid,i.x,i.y,i.angle,i.damage,i.ball_uuid,i.cur_skill):"blink"===s?this.receive_blink(e,i.tx,i.ty):"message"===s&&this.receive_chat_message(e,i.username,i.text)}}send_create_player(t,i,s,e,a){this.ws.send(JSON.stringify({event:"create_player",uuid:this.uuid,username:t,photo:i,px:s,py:e,total:a}))}receive_create_player(t,i,s,e,a){let h=new Player(this.playground,e,a,this.playground.player_radius,this.playground.player_color,this.playground.player_speed,"enemy",i,s);h.uuid=t,this.playground.players.push(h)}send_move_to(t,i){this.ws.send(JSON.stringify({event:"move_to",uuid:this.uuid,tx:t,ty:i}))}receive_move_to(t,i,s){let e=this.get_player(t);e&&e.move_to(i,s)}send_shoot_ball(t,i,s,e){this.ws.send(JSON.stringify({event:"shoot_ball",uuid:this.uuid,tx:t,ty:i,ball_uuid:s,cur_skill:e}))}receive_shoot_ball(t,i,s,e,a){let h=this.get_player(t);if(h){h.shoot_ball(i,s,a).uuid=e}}send_attack(t,i,s,e,a,h,l){this.ws.send(JSON.stringify({event:"attack",uuid:this.uuid,attackee_uuid:t,x:i,y:s,angle:e,damage:a,ball_uuid:h,cur_skill:l}))}receive_attack(t,i,s,e,a,h,l,n){let r=this.get_player(t),o=this.get_player(i);r&&o&&o.receive_attack(s,e,a,h,l,r,n)}send_blink(t,i){this.ws.send(JSON.stringify({event:"blink",uuid:this.uuid,tx:t,ty:i}))}receive_blink(t,i,s){let e=this.get_player(t);e&&e.blink(i,s)}send_chat_message(t,i){this.ws.send(JSON.stringify({event:"message",uuid:this.uuid,username:t,text:i}))}receive_chat_message(t,i,s){this.playground.chat_field.add_message(i,s)}}let RANDOM_HEX=["0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F"];class AcGamePlayground{constructor(t){this.root=t,this.$playground=$('\n<div class="ac-game-playground"></div>\n'),this.root.$ac_game.append(this.$playground),this.hide(),this.start()}get_random_color(){let t="#";for(let i=1;i<=6;++i)t+=RANDOM_HEX[Math.floor(Math.random()*RANDOM_HEX.length)];return t}create_uuid(){let t="";for(let i=0;i<8;i++)t+=Math.floor(10*Math.random());return t}start(){let t=this.create_uuid();$(window).on(`resize.${t}`,(()=>{this.resize()})),this.root.AcWingOS&&this.root.AcWingOS.api.window.on_close((function(){$(window).off(`resize.${t}`)}))}add_listening_events(){this.game_map.$canvas.on("contextmenu",(function(){return!1})),this.game_map.$canvas.keydown((t=>{if(13===t.which){if("multi mode"===this.mode&&"waiting"!==this.state)return this.chat_field.show_input(),!1}else if(27===t.which&&"multi mode"===this.mode&&"waiting"!==this.state)return this.chat_field.hide_input(),!1;if("over"!==this.state)return!0;81===t.which?(this.focus_index--,this.keydown_focus_player()):69===t.which&&(this.focus_index++,this.keydown_focus_player())}))}keydown_focus_player(){let t=this.players.length;this.focus_index=(this.focus_index%t+t)%t,this.focus_player=this.players[this.focus_index]}resize(){this.width=this.$playground.width(),this.height=this.$playground.height();let t=Math.min(this.width/16,this.height/9);this.width=16*t,this.height=9*t,this.scale=this.height,this.game_map&&this.game_map.resize(),this.mini_map&&this.mini_map.resize()}re_calculate_cx_cy(t=null,i=null){t&&i?(this.cx=t-this.width/2/this.scale,this.cy=i-this.height/2/this.scale):(this.focus_player=this.players[this.focus_index],this.cx=this.players[this.focus_index].x-this.width/2/this.scale,this.cy=this.players[this.focus_index].y-this.height/2/this.scale);let s=this.game_map.l;this.cx=Math.max(this.cx,-2*s),this.cx=Math.min(this.cx,this.virtual_map_width-(this.width/this.scale-2*s)),this.cy=Math.max(this.cy,-s),this.cy=Math.min(this.cy,this.virtual_map_height-(this.height/this.scale-s))}show(){if(this.$playground.show(),this.width=this.$playground.width(),this.height=this.$playground.height(),this.virtual_map_width=3,this.virtual_map_height=this.virtual_map_width,this.mode=this.root.menu.mode,this.player_count=0,this.players=[],this.state="waiting",this.player_radius=.045,this.player_speed=.25,this.player_color="rgb(203,11,10)",this.focus_index=0,this.game_map=new GameMap(this),this.notice_board=new NoticeBoard(this),this.score_board=new ScoreBoard(this),this.count_down=new CountDown(this),this.add_listening_events(),this.resize(),"single mode"===this.mode){let t=this.root.difficult.difficult_mode;if("easy"===t){let t=Math.random()*this.virtual_map_width,i=Math.random()*this.virtual_map_height;this.players.push(new Player(this,t,i,this.player_radius,this.player_color,this.player_speed,"me",this.root.settings.username,this.root.skin.img_src||this.root.settings.photo)),this.robot_total=10;for(let t=0;t<this.robot_total;t++){let t=Math.random()*this.virtual_map_width,i=Math.random()*this.virtual_map_height;this.players.push(new Player(this,t,i,this.player_radius,this.get_random_color(),.2,"robot"))}}else if("normal"===t){let t=Math.random()*this.virtual_map_width,i=Math.random()*this.virtual_map_height;this.players.push(new Player(this,t,i,this.player_radius,this.player_color,this.player_speed,"me",this.root.settings.username,this.root.skin.img_src||this.root.settings.photo)),this.robot_total=15;for(let t=0;t<this.robot_total;t++){let t=Math.random()*this.virtual_map_width,i=Math.random()*this.virtual_map_height;this.players.push(new Player(this,t,i,this.player_radius,this.get_random_color(),.25,"robot"))}}else if("hard"===t){Math.random(),this.virtual_map_width,Math.random(),this.virtual_map_height;this.players.push(new Player(this,.85*this.width/this.scale,1.5*this.height/this.scale,this.player_radius,this.player_color,this.player_speed,"me",this.root.settings.username,this.root.skin.img_src||this.root.settings.photo)),this.robot_total=25;for(let t=0;t<this.robot_total;t++)this.players.push(new Player(this,.85*this.width/this.scale,1.5*this.height/this.scale,this.player_radius,this.get_random_color(),.3,"robot"))}}else if("multi mode"===this.mode){let t=Math.random()*this.virtual_map_width,i=Math.random()*this.virtual_map_height;this.players.push(new Player(this,t,i,this.player_radius,this.player_color,this.player_speed,"me",this.root.settings.username,this.root.skin.img_src||this.root.settings.photo)),this.chat_field=new ChatField(this),this.mps=new MultiPlayerSocket(this),this.mps.uuid=this.players[0].uuid,this.mps.ws.onopen=()=>{this.mps.send_create_player(this.root.settings.username,this.root.skin.img_src||this.root.settings.photo,t,i,this.join_player_total)}}this.re_calculate_cx_cy(),this.mini_map=new MiniMap(this,this.game_map),this.mini_map.resize()}hide(){for(;this.players&&this.players.length>0;)this.players[0].destroy();this.notice_board&&(this.notice_board.destroy(),this.notice_board=null),this.score_board&&(this.score_board.destroy(),this.score_board=null),this.game_map&&(this.game_map.destroy(),this.game_map=null),this.$playground.empty(),this.$playground.hide()}}class Rank{constructor(t){this.root=t,this.$rank=$('\n        <div class=\'ac-game-rank\'>\n        <button class="btn btn-primary rank-back"><i class="bi bi-box-arrow-left"></i>&nbsp;&nbsp;返回</button>\n        <h1 class="text-center text-dark font-weight-bold mb-4">排行榜</h1>\n        <div class="rank-table">\n        <table class="table table-hover text-center">\n  <thead>\n    <tr>\n      <th scope="col">名次</th>\n      <th scope="col">用户名</th>\n      <th scope="col">头像</th>\n      <th scope="col">累计得分</th>\n    </tr>\n  </thead>\n  <tbody>\n  </tbody>\n</table>\n</div>\n<nav class="float-right mt-5">\n  <ul class="pagination"></ul>\n</nav>\n</div>\n        '),this.root.$ac_game.append(this.$rank),this.$back_button=$(".rank-back"),this.now_page=1,this.hide(),this.start()}start(){}add_listening_events(){this.$back_button.click((()=>{this.hide(),this.root.menu.show()})),$(".pre-page").click((()=>{if(this.now_page-=1,this.now_page<1)return this.now_page=1,!1;this.ajax_getRank()})),$(".next-page").click((()=>{if(this.now_page+=1,this.now_page>this.num_pages)return this.now_page=this.num_pages,!1;this.ajax_getRank()}));let t=this;$(".this-page").click((function(){t.now_page=parseInt(this.innerText),t.ajax_getRank()}))}init_ajax_getRank(){let t=this;$.ajax({url:"/rank/getRank",type:"GET",data:{page:1},success:i=>{$(".pagination").html(""),t.num_pages=i.num_pages,$(".pagination").append($('<li class="page-item pre-page disabled"><a class="page-link" href="javascript:;">上一页</a></li>'));for(let t=0;t<i.num_pages;t++){let i=$(`<li class="page-item this-page"><a class="page-link" href="javascript:;">${t+1}</a></li>`);$(".pagination").append(i)}$(".pagination").append($('<li class="page-item next-page"><a class="page-link" href="javascript:;">下一页</a></li>'));for(let t=0;t<i.playerList.length;t++){let s=i.playerList[t],e=$(`<tr>\n                                  <th class="align-middle">${s.num}</th>\n                                  <td class="align-middle">${s.username}</td>\n                                  <td class="align-middle"><img  class="img-thumbnail" src="${s.photo}" width="50"></td>\n                                  <td class="align-middle">${s.score}</td>\n                                </tr>`);$(".ac-game-rank tbody").append(e)}t.add_listening_events()}})}ajax_getRank(){$.ajax({url:"/rank/getRank",type:"GET",data:{page:this.now_page},success:t=>{t.has_previous?$(".pre-page").removeClass("disabled"):$(".pre-page").addClass("disabled"),t.has_next?$(".next-page").removeClass("disabled"):$(".next-page").addClass("disabled"),$(".ac-game-rank tbody").html("");for(let i=0;i<t.playerList.length;i++){let s=t.playerList[i],e=$(`<tr>\n                                  <th class="align-middle">${s.num}</th>\n                                  <td class="align-middle">${s.username}</td>\n                                  <td class="align-middle"><img  class="img-thumbnail" src="${s.photo}" width="50"></td>\n                                  <td class="align-middle">${s.score}</td>\n                                </tr>`);$(".ac-game-rank tbody").append(e)}}})}show(){this.$rank.show(),this.init_ajax_getRank()}hide(){this.$rank.hide()}}class Setting{constructor(t){this.root=t,this.$setting=$('\n<div class="ac-game-setting">\n    <div class="ac-game-setting-field">\n        <div class="setting-field-item setting-field-item-back">返回</div>\n        <br>\n        <br>\n        <div class="setting-field-item setting-field-item-voice">声音:开</div>\n        <br>\n        <br>\n        <div class="setting-field-item setting-field-item-description">游戏说明</div>\n        <br>\n        <br>\n        <div class="setting-field-item setting-field-item-logout">注销</div>\n    </div>\n    <div class="ac-game-setting-description">\n    游戏技能说明\n</div>\n</div>'),this.root.$ac_game.append(this.$setting),this.$setting_back=this.$setting.find(".setting-field-item-back"),this.$audio=$("audio"),this.$voice=this.$setting.find(".setting-field-item-voice"),this.$setting_description=this.$setting.find(".setting-field-item-description"),this.$logout=this.$setting.find(".setting-field-item-logout"),this.hide(),this.start()}start(){this.add_listening_events()}add_listening_events(){this.$setting_back.click((()=>{this.hide(),this.root.menu.show()})),this.$voice.click((()=>{this.$audio[0].paused?(this.$audio[0].play(),this.$voice.text("声音:开")):(this.$audio[0].pause(),this.$voice.text("声音:关"))})),this.$setting_description.mouseenter((()=>{$(".ac-game-setting-description").fadeIn(100)})),this.$setting_description.mouseleave((()=>{$(".ac-game-setting-description").fadeOut(100)})),this.$logout.click((()=>{this.root.settings.user_logout()}))}show(){this.$setting.show(),$(".ac-game-setting-description").hide()}hide(){this.$setting.hide()}}class Settings{constructor(t){this.root=t,this.username="",this.photo="",this.platform="web",this.root.AcWingOS&&(this.platform="ACAPP"),this.$settings=$('\n        <div class="acgame-settings">\n        <div class="settings-login">\n            <div class="login-tittle">\n                登录\n            </div>\n            <div class="login-username">\n                <div class="login-item">\n                    用户名：<input type="text" class="form-control" placeholder="请输入用户">\n                </div>\n            </div>\n            <div class="login-password">\n                <div class="login-item">\n                    密码：<input type="password" class="form-control" placeholder="请输入密码">\n                </div>\n            </div>\n            <div class="login-error-message">\n                <p class="text-danger"></p>\n            </div>\n            <div class="login-register">\n                <p class="text-muted">注册</p>\n            </div>\n            <div class="login-submit">\n                <div class="login-item">\n                    <button class="btn btn-primary">登录</button>\n                </div>\n            </div>\n            <div class="login-third-party">\n                <img src="https://app372.acapp.acwing.com.cn/static/image/settings/acwing_logo.png">\n                <p class="text-muted">AcWing一键登录</p>\n            </div>\n        </div>\n        <div class="settings-register">\n            <div class="register-tittle">\n                注册\n            </div>\n            <div class="register-username">\n                <div class="register-item">\n                    用户名：<input type="text" class="form-control" placeholder="请输入用户">\n                </div>\n            </div>\n            <div class="register-password">\n                <div class="register-item">\n                    密码：<input type="password" class="form-control" placeholder="请输入密码">\n                </div>\n            </div>\n            <div class="register-confirm-password">\n                <div class="register-item">\n                    确认密码：<input type="password" class="form-control" placeholder="请再次输入密码">\n                </div>\n            </div>\n            <div class="register-error-message">\n                <p class="text-danger"></p>\n            </div>\n            <div class="register-submit">\n                <div class="register-item">\n                    <button class="btn btn-primary">注册</button>\n                </div>\n            </div>\n            <div class="register-back">\n                <div class="register-item">\n                    <button class="btn btn-primary">返回</button>\n                </div>\n            </div>\n        </div>\n    </div>\n        '),this.$login=this.$settings.find(".settings-login"),this.$login_username=this.$settings.find(".login-username input"),this.$login_password=this.$settings.find(".login-password input"),this.$login_error_message=this.$settings.find(".login-error-message p"),this.$login_register=this.$settings.find(".login-register p"),this.$login_submit=this.$settings.find(".login-submit button"),this.$login.hide(),this.$register=this.$settings.find(".settings-register"),this.$register_username=this.$settings.find(".register-username input"),this.$register_password=this.$settings.find(".register-password input"),this.$register_confirm_password=this.$settings.find(".register-confirm-password input"),this.$register_error_message=this.$settings.find(".register-error-message p"),this.$register_submit=this.$settings.find(".register-submit button"),this.$register_back=this.$settings.find(".register-back button"),this.$register.hide(),this.$login_third_party=this.$settings.find(".login-third-party"),this.root.$ac_game.append(this.$settings),this.start()}add_listening_events(){this.add_listening_events_login(),this.add_listening_events_register(),this.$login_third_party.click((()=>{this.user_login_third()}))}add_listening_events_login(){this.$login_register.click((()=>{this.$login.fadeOut(300),setTimeout((()=>{this.$register.fadeIn(300)}),300)})),this.$login_submit.click((()=>{this.user_login()}))}add_listening_events_register(){this.$register_back.click((()=>{this.$register.fadeOut(300),setTimeout((()=>{this.$login.fadeIn(300)}),300)})),this.$register_submit.click((()=>{this.user_register()}))}user_login_third(){$.ajax({url:"https://app372.acapp.acwing.com.cn/settings/acwing/web/apply_code/",type:"GET",success:function(t){"success"===t.result&&location.replace(t.apply_code_url)}})}user_login(){let t=this.$login_username.val(),i=this.$login_password.val();this.$login_error_message.text()&&this.$login_error_message.empty();let s=this;$.ajax({url:"https://app372.acapp.acwing.com.cn/settings/login/",type:"GET",data:{username:t,password:i},success:function(t){"success"===t.result?location.reload():s.$login_error_message.html(t.result)}})}user_logout(){"ACAPP"===this.platform?this.root.AcWingOS.api.window.close():$.ajax({url:"https://app372.acapp.acwing.com.cn/settings/logout/",type:"GET",success:function(t){"success"===t.result&&location.reload()}})}user_register(){let t=this.$register_username.val(),i=this.$register_password.val(),s=this.$register_confirm_password.val();this.$register_error_message.text()&&this.$register_error_message.empty();let e=this;$.ajax({url:"https://app372.acapp.acwing.com.cn/settings/register/",type:"GET",data:{username:t,password:i,confirm_password:s},success:function(t){"success"===t.result?location.reload():e.$register_error_message.html(t.result)}})}start(){$("audio")[0].pause(),"web"===this.platform?(this.getinfo_web(),this.add_listening_events()):this.getinfo_acapp()}register(){this.$login.hide(),this.$register.show()}login(){this.$register.hide(),this.$login.show()}getinfo_web(){let t=this;$.ajax({url:"https://app372.acapp.acwing.com.cn/settings/getinfo/",type:"GET",data:{platform:t.platform},success:function(i){"success"===i.result?(t.username=i.username,t.photo=i.photo,t.hide(),t.root.menu.show()):t.login()}})}getinfo_acapp(){let t=this;$.ajax({url:"https://app372.acapp.acwing.com.cn/settings/acwing/acapp/apply_code/",type:"GET",success:function(i){"success"===i.result&&t.acapp_login(i.appid,i.redirect_uri,i.scope,i.state)}})}acapp_login(t,i,s,e){let a=this;this.root.AcWingOS.api.oauth2.authorize(t,i,s,e,(function(t){"success"===t.result&&(a.username=t.username,a.photo=t.photo,a.hide(),a.root.menu.show())}))}hide(){this.$settings.hide()}show(){$("audio")[0].pause(),this.$settings.show()}}class Skin{constructor(t){this.root=t,this.$skin=$('\n        <div class="ac-game-skin">\n            <button class="btn btn-primary skin-back"><i class="bi bi-box-arrow-left"></i>&nbsp;&nbsp;返回</button>\n            <div id="carouselSkin" class="carousel slide" data-interval="false" data-ride="carousel">\n              <ol class="carousel-indicators"></ol>\n              <div class="carousel-inner"></div>\n              <button class="carousel-control-prev" data-target="#carouselSkin" data-slide="prev">\n                <span class="carousel-control-prev-icon"></span>\n              </button>\n              <button class="carousel-control-next" data-target="#carouselSkin" data-slide="next">\n                <span class="carousel-control-next-icon"></span>\n              </button>\n            </div>\n        </div>\n        '),this.root.$ac_game.append(this.$skin),this.$skin_back=$(".skin-back"),this.$img_carousel_indicators=$(".carousel-indicators"),this.$img_carousel_inner=$(".carousel-inner"),this.hide(),this.start()}start(){}getSkin(){let t=this;$.ajax({url:"https://app372.acapp.acwing.com.cn/skin/getSkin/",type:"GET",async:!1,success:function(i){t.$img_carousel_indicators.html(""),t.$img_carousel_inner.html("");let s=$(`\n                    <div class="carousel-item active text-center">\n                      <img src="${t.root.settings.photo}" class="d-block">\n                      <div class="carousel-caption d-none d-md-block">\n                        <h3>默认</h3>\n                        <p>头像作为皮肤</p>\n                      </div>\n                    </div>\n                    <div class="carousel-item">\n                      <img src="https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fpic71.nipic.com%2Ffile%2F20150708%2F2531170_112540524000_2.jpg&refer=http%3A%2F%2Fpic71.nipic.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=jpeg?sec=1643209349&t=a16aeb09adb0eb09ad3a978de31f09f8" class="d-block">\n                      <div class="carousel-caption d-none d-md-block">\n                        <h3>随机</h3>\n                        <p>随机皮肤</p>\n                      </div>\n                    </div>\n                `),e=$('\n                    <li data-target="#carouselSkin" data-slide-to="0" class="active"></li>\n                    <li data-target="#carouselSkin" data-slide-to="1"></li>\n                ');t.$img_carousel_indicators.append(e),t.$img_carousel_inner.append(s);for(let s=0;s<i.data.length;s++){let e=$(`<li data-target="#carouselSkin" data-slide-to="${s+2}"></li>`),a=i.data[s],h=$(`\n                    <div class="carousel-item">\n                      <img src="${a.imgSrc}" class="d-block">\n                      <div class="carousel-caption d-none d-md-block">\n                        <h3>${a.name}</h3>\n                        <p>${a.description}</p>\n                      </div>\n                    </div>\n                    `);t.$img_carousel_indicators.append(e),t.$img_carousel_inner.append(h)}t.$img=$(".carousel-item img")}})}add_listening_events(){this.$skin_back.click((()=>{this.hide(),"single mode"===this.root.menu.mode?this.root.difficult.show():"multi mode"===this.root.menu.mode&&this.root.melee.show()}));let t=this;this.$img.click((function(){1===$(this).parent().index()?t.img_src=t.$img[Math.floor(Math.random()*(t.$img.length-2)+2)].currentSrc:t.img_src=$(this)[0].currentSrc,t.hide(),t.root.playground.show()}))}show(){this.getSkin(),this.add_listening_events(),this.$skin.show()}hide(){this.$skin.hide()}}export class AcGame{constructor(t,i){this.id=t,this.AcWingOS=i,this.$ac_game=$("#"+this.id),this.settings=new Settings(this),this.menu=new AcGameMenu(this),this.rank=new Rank(this),this.setting=new Setting(this),this.difficult=new Difficult(this),this.melee=new Melee(this),this.skin=new Skin(this),this.playground=new AcGamePlayground(this),this.start()}start(){}}
